<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Roller - TTRPG Toolkit</title>
    <link rel="stylesheet" href="file:///android_asset/css/style.css">
</head>
<body>
    <nav class="navbar">
        <h1>TTRPG Toolkit</h1>
        <div class="nav-tabs">
            <a href="index.html">Dashboard</a>
            <a href="dice-roller.html" class="active">Dice</a>
            <a href="character-sheet.html">Characters</a>
            <a href="random-generator.html">Generators</a>
            <a href="notes.html">Notes</a>
            <a href="map.html">Map</a>
            <a href="battle.html">Battle</a>
            <a href="database.html">Database</a>
            <a href="multiplayer.html">Multiplayer</a>
            <a href="settings.html">Settings</a>
        </div>
    </nav>

    <main class="container">
        <!-- Quick Roll Section -->
        <section class="card">
            <h2>Quick Roll</h2>
            <div class="dice-controls">
                <div class="dice-input">
                    <input type="number" id="diceCount" value="1" min="1" max="100">
                    <span>d</span>
                    <input type="number" id="diceSides" value="20" min="2" max="1000">
                    <span>+</span>
                    <input type="number" id="diceMod" value="0" min="-1000" max="1000">
                </div>
                
                <div class="roll-style-selector">
                    <label>Roll Style:</label>
                    <select id="rollStyle">
                        <option value="normal">Normal</option>
                        <option value="advantage">Advantage (D&D 5e)</option>
                        <option value="disadvantage">Disadvantage (D&D 5e)</option>
                        <option value="critical">Critical Success/Fail</option>
                        <option value="fate">Fate Dice (+/-)</option>
                        <option value="wild">Wild Die (Savage Worlds)</option>
                    </select>
                </div>
                
                <button onclick="rollDice()" class="btn-primary">Roll Dice</button>
                
                <div id="diceVisual" class="dice-visual-container"></div>
                
                <div id="rollResult" class="roll-result">
                    <span>Result: </span><span id="resultValue">-</span>
                </div>
                <div id="rollDetails" class="roll-details"></div>
            </div>
        </section>

        <!-- Quick Dice Buttons -->
        <section class="card">
            <h2>Quick Dice</h2>
            <div class="quick-dice-buttons">
                <button onclick="quickRoll('d4')" class="dice-btn" data-sides="4">d4</button>
                <button onclick="quickRoll('d6')" class="dice-btn" data-sides="6">d6</button>
                <button onclick="quickRoll('d8')" class="dice-btn" data-sides="8">d8</button>
                <button onclick="quickRoll('d10')" class="dice-btn" data-sides="10">d10</button>
                <button onclick="quickRoll('d12')" class="dice-btn" data-sides="12">d12</button>
                <button onclick="quickRoll('d20')" class="dice-btn" data-sides="20">d20</button>
                <button onclick="quickRoll('d100')" class="dice-btn" data-sides="100">d100</button>
                <button onclick="rollFate()" class="dice-btn fate">Fate</button>
                <button onclick="rollWild()" class="dice-btn wild">Wild</button>
            </div>
        </section>

        <!-- Saved Dice Sets -->
        <section class="card">
            <div class="card-header">
                <h2>Saved Dice Sets</h2>
                <button onclick="addDiceSet()" class="btn-primary">Add New Set</button>
            </div>
            <div id="savedDiceSets" class="dice-sets">
                <!-- Dice sets will be loaded here -->
            </div>
        </section>

        <!-- Roll History -->
        <section class="card">
            <div class="card-header">
                <h2>Roll History</h2>
                <button onclick="clearRollHistory()" class="btn-danger">Clear History</button>
            </div>
            <div id="rollHistory" class="roll-history">
                <!-- Roll history will be loaded here -->
            </div>
        </section>

        <!-- Dice Set Editor Modal -->
        <div id="diceSetModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>Add Dice Set</h2>
                <div class="form-group">
                    <label>Set Name:</label>
                    <input type="text" id="setName" placeholder="Attack Roll">
                </div>
                <div class="form-group">
                    <label>Dice Formula:</label>
                    <input type="text" id="setFormula" placeholder="1d20+5">
                    <small>Format: [number]d[sides][+/-modifier] (e.g., 2d6+3)</small>
                </div>
                <div class="modal-actions">
                    <button onclick="saveDiceSet()" class="btn-primary">Save Set</button>
                    <button onclick="closeDiceSetModal()" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <script src="file:///android_asset/js/main.js"></script>
    <script src="file:///android_asset/js/emojis.js"></script>
    <script>
        let rollHistory = JSON.parse(localStorage.getItem('rollHistory') || '[]');
        let diceSets = JSON.parse(localStorage.getItem('diceSets') || '[]');
        let editingSetId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadDiceSets();
            displayRollHistory();
            updateDiceFromSettings();
        });

        function updateDiceFromSettings() {
            const defaultDice = localStorage.getItem('defaultDice') || 'd20';
            const diceMatch = defaultDice.match(/d(\d+)/i);
            if (diceMatch) {
                document.getElementById('diceSides').value = diceMatch[1];
            }
        }

        function rollDice() {
            const count = parseInt(document.getElementById('diceCount').value) || 1;
            const sides = parseInt(document.getElementById('diceSides').value) || 20;
            const mod = parseInt(document.getElementById('diceMod').value) || 0;
            const style = document.getElementById('rollStyle').value;
            
            clearDiceVisual();
            
            let total = 0;
            let rolls = [];
            let finalResult = 0;
            let formula = '';
            let resultText = '';
            let isCritical = false;
            let isFumble = false;
            
            switch(style) {
                case 'advantage':
                    const roll1 = Math.floor(Math.random() * sides) + 1;
                    const roll2 = Math.floor(Math.random() * sides) + 1;
                    const advantageRoll = Math.max(roll1, roll2);
                    rolls = [roll1, roll2];
                    total = advantageRoll;
                    finalResult = advantageRoll + mod;
                    formula = `Advantage: max(1d${sides})${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = max([${roll1}, ${roll2}])${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    break;
                    
                case 'disadvantage':
                    const roll1d = Math.floor(Math.random() * sides) + 1;
                    const roll2d = Math.floor(Math.random() * sides) + 1;
                    const disadvantageRoll = Math.min(roll1d, roll2d);
                    rolls = [roll1d, roll2d];
                    total = disadvantageRoll;
                    finalResult = disadvantageRoll + mod;
                    formula = `Disadvantage: min(1d${sides})${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = min([${roll1d}, ${roll2d}])${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    break;
                    
                case 'fate':
                    const fateResults = [];
                    let fateTotal = 0;
                    for (let i = 0; i < 4; i++) {
                        const fateRoll = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                        fateResults.push(fateRoll);
                        fateTotal += fateRoll;
                    }
                    rolls = fateResults;
                    total = fateTotal;
                    finalResult = fateTotal;
                    formula = '4dF (Fate Dice)';
                    resultText = `${formula} = [${fateResults.join(', ')}] = ${finalResult}`;
                    break;
                    
                case 'wild':
                    const wildDie = Math.floor(Math.random() * 6) + 1;
                    const traitDie = Math.floor(Math.random() * sides) + 1;
                    rolls = [wildDie, traitDie];
                    total = Math.max(wildDie, traitDie);
                    finalResult = total + mod;
                    formula = `Wild Die: max(1d6, 1d${sides})${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = max([${wildDie}, ${traitDie}])${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    if (wildDie === 6) {
                        resultText += ' (WILD!)';
                    }
                    break;
                    
                case 'critical':
                    let criticalRolls = [];
                    let criticalTotal = 0;
                    for (let i = 0; i < count; i++) {
                        const roll = Math.floor(Math.random() * sides) + 1;
                        criticalRolls.push(roll);
                        criticalTotal += roll;
                        
                        // Check for critical success/failure
                        if (sides === 20) {
                            if (roll === 20) isCritical = true;
                            if (roll === 1) isFumble = true;
                        }
                    }
                    finalResult = criticalTotal + mod;
                    formula = `${count}d${sides}${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = [${criticalRolls.join(' + ')}]${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    if (isCritical) resultText += ' ðŸŽ‰ CRITICAL SUCCESS!';
                    if (isFumble) resultText += ' ðŸ’¥ CRITICAL FAILURE!';
                    rolls = criticalRolls;
                    break;
                    
                default: // normal
                    for (let i = 0; i < count; i++) {
                        const roll = Math.floor(Math.random() * sides) + 1;
                        rolls.push(roll);
                        total += roll;
                    }
                    finalResult = total + mod;
                    formula = `${count}d${sides}${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = [${rolls.join(' + ')}]${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
            }
            
            displayDiceVisual(rolls, sides, style, isCritical, isFumble);
            document.getElementById('resultValue').textContent = finalResult;
            document.getElementById('rollDetails').innerHTML = `<div>${resultText}</div>`;
            
            // Save to history
            const timestamp = new Date().toLocaleTimeString();
            const historyEntry = {
                id: TTRPGToolkit.generateId(),
                formula, 
                result: finalResult, 
                details: resultText, 
                time: timestamp,
                rolls: rolls,
                style: style,
                isCritical,
                isFumble
            };
            
            rollHistory.unshift(historyEntry);
            rollHistory = rollHistory.slice(0, 50); // Keep last 50 rolls
            localStorage.setItem('rollHistory', JSON.stringify(rollHistory));
            displayRollHistory();
            
            // Update recent rolls for dashboard
            const recentRolls = JSON.parse(localStorage.getItem('recentRolls') || '[]');
            recentRolls.unshift(`${formula}: ${finalResult}`);
            recentRolls.splice(5);
            localStorage.setItem('recentRolls', JSON.stringify(recentRolls));
            
            // Haptic feedback (if available)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function quickRoll(diceType) {
            const sides = parseInt(diceType.substring(1));
            document.getElementById('diceSides').value = sides;
            document.getElementById('diceCount').value = 1;
            document.getElementById('diceMod').value = 0;
            document.getElementById('rollStyle').value = 'normal';
            rollDice();
        }

        function rollFate() {
            document.getElementById('rollStyle').value = 'fate';
            document.getElementById('diceCount').value = 4;
            document.getElementById('diceSides').value = 3;
            document.getElementById('diceMod').value = 0;
            rollDice();
        }

        function rollWild() {
            document.getElementById('rollStyle').value = 'wild';
            document.getElementById('diceCount').value = 1;
            document.getElementById('diceMod').value = 0;
            rollDice();
        }

        function displayDiceVisual(rolls, sides, style, isCritical = false, isFumble = false) {
            const container = document.getElementById('diceVisual');
            container.innerHTML = '';
            
            if (style === 'fate') {
                rolls.forEach((roll, index) => {
                    const die = document.createElement('div');
                    die.className = 'fate-die';
                    die.textContent = roll === 1 ? '+' : roll === -1 ? '-' : '0';
                    die.style.cssText = `
                        display: inline-block;
                        width: 40px;
                        height: 40px;
                        border: 2px solid var(--accent);
                        border-radius: 4px;
                        text-align: center;
                        line-height: 40px;
                        margin: 5px;
                        font-weight: bold;
                        background: var(--bg-secondary);
                        font-size: 1.2rem;
                    `;
                    container.appendChild(die);
                });
            } else {
                rolls.forEach((roll, index) => {
                    const die = document.createElement('div');
                    die.className = 'visual-die';
                    die.textContent = roll;
                    die.style.cssText = `
                        display: inline-block;
                        width: 50px;
                        height: 50px;
                        border: 2px solid var(--accent);
                        border-radius: 8px;
                        text-align: center;
                        line-height: 50px;
                        margin: 5px;
                        font-weight: bold;
                        font-size: 1.2rem;
                        background: var(--bg-secondary);
                        animation: diceRoll 0.5s ease-in-out;
                    `;
                    
                    // Special styling for critical rolls
                    if (sides === 20) {
                        if (roll === 20 || isCritical) {
                            die.style.background = 'var(--success)';
                            die.style.color = 'var(--bg-primary)';
                            die.style.borderColor = 'var(--success)';
                        } else if (roll === 1 || isFumble) {
                            die.style.background = 'var(--danger)';
                            die.style.color = 'white';
                            die.style.borderColor = 'var(--danger)';
                        }
                    }
                    
                    container.appendChild(die);
                });
            }
        }

        function clearDiceVisual() {
            document.getElementById('diceVisual').innerHTML = '';
        }

        function addDiceSet() {
            document.getElementById('diceSetModal').style.display = 'flex';
            document.getElementById('setName').value = '';
            document.getElementById('setFormula').value = '';
            editingSetId = null;
        }

        function saveDiceSet() {
            const name = document.getElementById('setName').value.trim();
            const formula = document.getElementById('setFormula').value.trim();
            
            if (!name || !formula) {
                TTRPGToolkit.showNotification('Please enter both name and formula!', 'error');
                return;
            }
            
            // Validate formula
            if (!formula.match(/^(\d*)d(\d+)([+-]\d+)?$/i)) {
                TTRPGToolkit.showNotification('Invalid dice formula! Use format like "2d6+3"', 'error');
                return;
            }
            
            const diceSet = {
                id: editingSetId || TTRPGToolkit.generateId(),
                name,
                formula
            };
            
            if (editingSetId) {
                const index = diceSets.findIndex(set => set.id === editingSetId);
                diceSets[index] = diceSet;
            } else {
                diceSets.unshift(diceSet);
            }
            
            localStorage.setItem('diceSets', JSON.stringify(diceSets));
            loadDiceSets();
            closeDiceSetModal();
            TTRPGToolkit.showNotification('Dice set saved!', 'success');
        }

        function closeDiceSetModal() {
            document.getElementById('diceSetModal').style.display = 'none';
        }

        function loadDiceSets() {
            const container = document.getElementById('savedDiceSets');
            
            if (diceSets.length === 0) {
                container.innerHTML = '<p>No saved sets yet. Add one!</p>';
                return;
            }
            
            container.innerHTML = diceSets.map(set => `
                <div class="dice-set">
                    <div class="set-info">
                        <span class="set-name">${set.name}</span>
                        <span class="set-formula">${set.formula}</span>
                    </div>
                    <div class="set-actions">
                        <button onclick="rollSavedSet('${set.id}')" class="btn-primary">Roll</button>
                        <button onclick="editDiceSet('${set.id}')" class="btn-secondary">Edit</button>
                        <button onclick="deleteDiceSet('${set.id}')" class="btn-danger">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function rollSavedSet(setId) {
            const set = diceSets.find(s => s.id === setId);
            if (!set) return;
            
            const match = set.formula.match(/(\d*)d(\d+)([+-]\d+)?/i);
            if (!match) {
                TTRPGToolkit.showNotification('Invalid dice set formula!', 'error');
                return;
            }
            
            const count = parseInt(match[1]) || 1;
            const sides = parseInt(match[2]);
            const mod = parseInt(match[3]) || 0;
            
            // Set the form values
            document.getElementById('diceCount').value = count;
            document.getElementById('diceSides').value = sides;
            document.getElementById('diceMod').value = mod;
            document.getElementById('rollStyle').value = 'normal';
            
            // Roll the dice
            rollDice();
        }

        function editDiceSet(setId) {
            const set = diceSets.find(s => s.id === setId);
            if (!set) return;
            
            editingSetId = setId;
            document.getElementById('setName').value = set.name;
            document.getElementById('setFormula').value = set.formula;
            document.getElementById('diceSetModal').style.display = 'flex';
        }

        function deleteDiceSet(setId) {
            if (!confirm('Delete this dice set?')) return;
            
            diceSets = diceSets.filter(set => set.id !== setId);
            localStorage.setItem('diceSets', JSON.stringify(diceSets));
            loadDiceSets();
            TTRPGToolkit.showNotification('Dice set deleted!', 'success');
        }

        function displayRollHistory() {
            const container = document.getElementById('rollHistory');
            if (rollHistory.length === 0) {
                container.innerHTML = '<p>No rolls yet...</p>';
                return;
            }
            
            container.innerHTML = rollHistory.slice(0, 10).map(entry => `
                <div class="history-item ${entry.isCritical ? 'critical-success' : ''} ${entry.isFumble ? 'critical-fail' : ''}">
                    <div class="history-main">
                        <strong>${entry.formula}</strong> = ${entry.result}
                        ${entry.isCritical ? ' ðŸŽ‰' : ''}
                        ${entry.isFumble ? ' ðŸ’¥' : ''}
                    </div>
                    <div class="history-details">
                        <small>${entry.details}</small>
                        <small class="history-time">${entry.time}</small>
                    </div>
                </div>
            `).join('');
        }

        function clearRollHistory() {
            if (confirm('Clear all roll history?')) {
                rollHistory = [];
                localStorage.removeItem('rollHistory');
                displayRollHistory();
                TTRPGToolkit.showNotification('Roll history cleared!', 'success');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Spacebar to roll
            if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                rollDice();
            }
            
            // Number keys for quick dice
            if (e.code >= 'Digit1' && e.code <= 'Digit6' && e.ctrlKey) {
                e.preventDefault();
                const diceMap = {
                    'Digit1': 'd4',
                    'Digit2': 'd6', 
                    'Digit3': 'd8',
                    'Digit4': 'd10',
                    'Digit5': 'd12',
                    'Digit6': 'd20'
                };
                quickRoll(diceMap[e.code]);
            }
        });
    </script>

    <style>
        .dice-controls {
            display: grid;
            gap: 1rem;
        }

        .dice-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dice-input input {
            width: 80px;
            text-align: center;
        }

        .roll-style-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .roll-style-selector select {
            width: auto;
        }

        .quick-dice-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .dice-btn {
            padding: 1rem 0.5rem;
            border: 2px solid var(--accent);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1.1rem;
        }

        .dice-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        .dice-btn.fate {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: white;
            border-color: #8B4513;
        }

        .dice-btn.wild {
            background: linear-gradient(45deg, #FF6B35, #FF8E53);
            color: white;
            border-color: #FF6B35;
        }

        .dice-visual-container {
            min-height: 80px;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .roll-details {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            border: 1px solid var(--border);
        }

        .dice-sets {
            display: grid;
            gap: 0.5rem;
        }

        .dice-set {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }

        .dice-set:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .set-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .set-name {
            font-weight: bold;
            color: var(--accent);
        }

        .set-formula {
            font-family: 'Courier New', monospace;
            color: var(--text-secondary);
        }

        .set-actions {
            display: flex;
            gap: 0.5rem;
        }

        .history-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .history-item:hover {
            background: var(--bg-secondary);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item.critical-success {
            border-left: 4px solid var(--success);
            background: rgba(68, 255, 68, 0.1);
        }

        .history-item.critical-fail {
            border-left: 4px solid var(--danger);
            background: rgba(255, 68, 68, 0.1);
        }

        .history-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-time {
            color: var(--text-secondary);
        }

        .fate-die {
            animation: diceRoll 0.5s ease-in-out;
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(0.8); opacity: 0; }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .dice-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .dice-input input {
                width: 100%;
            }
            
            .roll-style-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-dice-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .dice-set {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .set-actions {
                width: 100%;
            }
            
            .set-actions button {
                flex: 1;
            }
            
            .history-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .history-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>
