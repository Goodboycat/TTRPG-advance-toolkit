<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Roller - TTRPG Toolkit</title>
    <link rel="stylesheet" href="file:///android_asset/css/style.css">
</head>
<body>
    <nav class="navbar">
        <h1>TTRPG Toolkit</h1>
        <div class="nav-tabs">
            <a href="index.html">Dashboard</a>
            <a href="dice-roller.html" class="active">Dice</a>
            <a href="character-sheet.html">Characters</a>
            <a href="random-generator.html">Generators</a>
            <a href="notes.html">Notes</a>
            <a href="map.html">Map</a>
            <a href="settings.html">Settings</a>
        </div>
    </nav>

    <main class="container">
        <section class="card">
            <h2 contenteditable="true">Quick Roll</h2>
            <div class="dice-controls">
                <div class="dice-input">
                    <input type="number" id="diceCount" value="1" min="1" max="100">
                    <span contenteditable="true" id="diceTypeLabel">d</span>
                    <input type="number" id="diceSides" value="20" min="2" max="1000">
                    <span contenteditable="true">+</span>
                    <input type="number" id="diceMod" value="0" min="-100" max="100">
                </div>
                <div class="roll-style-selector">
                    <label contenteditable="true">Roll Style:</label>
                    <select id="rollStyle">
                        <option value="normal">Normal</option>
                        <option value="advantage">Advantage (D&D 5e)</option>
                        <option value="disadvantage">Disadvantage (D&D 5e)</option>
                        <option value="critical">Critical Success/Fail</option>
                        <option value="fate">Fate Dice (+/-)</option>
                    </select>
                </div>
                <button onclick="rollDice()" class="btn-primary" contenteditable="true">Roll Dice</button>
                
                <div id="diceVisual" class="dice-visual-container"></div>
                
                <div id="rollResult" class="roll-result">
                    <span contenteditable="true">Result: </span><span id="resultValue">-</span>
                </div>
                <div id="rollDetails" class="roll-details"></div>
            </div>
        </section>

        <section class="card">
            <h2 contenteditable="true">Quick Dice</h2>
            <div class="quick-dice-buttons">
                <button onclick="quickRoll('d4')" class="dice-btn" data-sides="4">d4</button>
                <button onclick="quickRoll('d6')" class="dice-btn" data-sides="6">d6</button>
                <button onclick="quickRoll('d8')" class="dice-btn" data-sides="8">d8</button>
                <button onclick="quickRoll('d10')" class="dice-btn" data-sides="10">d10</button>
                <button onclick="quickRoll('d12')" class="dice-btn" data-sides="12">d12</button>
                <button onclick="quickRoll('d20')" class="dice-btn" data-sides="20">d20</button>
                <button onclick="quickRoll('d100')" class="dice-btn" data-sides="100">d100</button>
                <button onclick="rollFate()" class="dice-btn fate" contenteditable="true">Fate</button>
            </div>
        </section>

        <section class="card">
            <h2 contenteditable="true">Saved Dice Sets</h2>
            <div id="savedDiceSets" class="dice-sets">
                <div class="dice-set" contenteditable="true">
                    <span class="set-name">Attack Roll</span>
                    <span class="set-formula">1d20+5</span>
                    <button onclick="rollSet(this)">Roll</button>
                    <button onclick="removeSet(this)">X</button>
                </div>
            </div>
            <button onclick="addDiceSet()" class="btn-secondary" contenteditable="true">Add New Set</button>
        </section>

        <section class="card">
            <h2 contenteditable="true">Roll History</h2>
            <div id="rollHistory" class="roll-history"></div>
            <button onclick="clearRollHistory()" class="btn-danger" contenteditable="true">Clear History</button>
        </section>
    </main>

    <script src="file:///android_asset/js/main.js"></script>
    <script>
        let rollHistory = JSON.parse(localStorage.getItem('rollHistory') || '[]');

        document.addEventListener('DOMContentLoaded', function() {
            loadDiceSets();
            displayRollHistory();
            
            // Load default dice from settings
            const defaultDice = localStorage.getItem('defaultDice') || 'd20';
            const diceMatch = defaultDice.match(/d(\d+)/i);
            if (diceMatch) {
                document.getElementById('diceSides').value = diceMatch[1];
            }
        });

        function rollDice() {
            const count = parseInt(document.getElementById('diceCount').value) || 1;
            const sides = parseInt(document.getElementById('diceSides').value) || 20;
            const mod = parseInt(document.getElementById('diceMod').value) || 0;
            const style = document.getElementById('rollStyle').value;
            
            clearDiceVisual();
            
            let total = 0;
            let rolls = [];
            let finalResult = 0;
            let formula = '';
            let resultText = '';
            
            switch(style) {
                case 'advantage':
                    const roll1 = Math.floor(Math.random() * sides) + 1;
                    const roll2 = Math.floor(Math.random() * sides) + 1;
                    const advantageRoll = Math.max(roll1, roll2);
                    rolls = [roll1, roll2];
                    total = advantageRoll;
                    finalResult = advantageRoll + mod;
                    formula = `Advantage: max(1d${sides})${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = max([${roll1}, ${roll2}])${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    break;
                    
                case 'disadvantage':
                    const roll1d = Math.floor(Math.random() * sides) + 1;
                    const roll2d = Math.floor(Math.random() * sides) + 1;
                    const disadvantageRoll = Math.min(roll1d, roll2d);
                    rolls = [roll1d, roll2d];
                    total = disadvantageRoll;
                    finalResult = disadvantageRoll + mod;
                    formula = `Disadvantage: min(1d${sides})${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = min([${roll1d}, ${roll2d}])${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
                    break;
                    
                case 'fate':
                    const fateResults = [];
                    let fateTotal = 0;
                    for (let i = 0; i < 4; i++) {
                        const fateRoll = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                        fateResults.push(fateRoll);
                        fateTotal += fateRoll;
                    }
                    rolls = fateResults;
                    total = fateTotal;
                    finalResult = fateTotal;
                    formula = '4dF (Fate Dice)';
                    resultText = `${formula} = [${fateResults.join(', ')}] = ${finalResult}`;
                    break;
                    
                default:
                    for (let i = 0; i < count; i++) {
                        const roll = Math.floor(Math.random() * sides) + 1;
                        rolls.push(roll);
                        total += roll;
                    }
                    finalResult = total + mod;
                    formula = `${count}d${sides}${mod >= 0 ? '+' : ''}${mod}`;
                    resultText = `${formula} = [${rolls.join(' + ')}]${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
            }
            
            displayDiceVisual(rolls, sides, style);
            document.getElementById('resultValue').textContent = finalResult;
            document.getElementById('rollDetails').innerHTML = `<div contenteditable="true">${resultText}</div>`;
            
            const timestamp = new Date().toLocaleTimeString();
            rollHistory.unshift({
                formula, 
                result: finalResult, 
                details: resultText, 
                time: timestamp,
                rolls: rolls,
                style: style
            });
            rollHistory = rollHistory.slice(0, 50);
            localStorage.setItem('rollHistory', JSON.stringify(rollHistory));
            displayRollHistory();
            
            const recentRolls = JSON.parse(localStorage.getItem('recentRolls') || '[]');
            recentRolls.unshift(`${formula}: ${finalResult}`);
            recentRolls.splice(5);
            localStorage.setItem('recentRolls', JSON.stringify(recentRolls));
        }

        function quickRoll(diceType) {
            const sides = parseInt(diceType.substring(1));
            document.getElementById('diceSides').value = sides;
            document.getElementById('diceCount').value = 1;
            document.getElementById('diceMod').value = 0;
            document.getElementById('rollStyle').value = 'normal';
            rollDice();
        }

        function rollFate() {
            document.getElementById('rollStyle').value = 'fate';
            rollDice();
        }

        function displayDiceVisual(rolls, sides, style) {
            const container = document.getElementById('diceVisual');
            container.innerHTML = '';
            
            if (style === 'fate') {
                rolls.forEach((roll, index) => {
                    const die = document.createElement('div');
                    die.className = 'fate-die';
                    die.textContent = roll === 1 ? '+' : roll === -1 ? '-' : '0';
                    die.style.cssText = `
                        display: inline-block;
                        width: 40px;
                        height: 40px;
                        border: 2px solid var(--accent);
                        border-radius: 4px;
                        text-align: center;
                        line-height: 40px;
                        margin: 5px;
                        font-weight: bold;
                        background: var(--bg-secondary);
                    `;
                    container.appendChild(die);
                });
            } else {
                rolls.forEach((roll, index) => {
                    const die = document.createElement('div');
                    die.className = 'visual-die';
                    die.textContent = roll;
                    die.style.cssText = `
                        display: inline-block;
                        width: 50px;
                        height: 50px;
                        border: 2px solid var(--accent);
                        border-radius: 8px;
                        text-align: center;
                        line-height: 50px;
                        margin: 5px;
                        font-weight: bold;
                        font-size: 1.2rem;
                        background: var(--bg-secondary);
                        animation: diceRoll 0.5s ease-in-out;
                    `;
                    
                    // Special styling for critical rolls
                    if (sides === 20) {
                        if (roll === 20) {
                            die.style.background = 'var(--success)';
                            die.style.color = 'var(--bg-primary)';
                        } else if (roll === 1) {
                            die.style.background = 'var(--danger)';
                            die.style.color = 'white';
                        }
                    }
                    
                    container.appendChild(die);
                });
            }
        }

        function clearDiceVisual() {
            document.getElementById('diceVisual').innerHTML = '';
        }

        // ... rest of the existing dice functions (addDiceSet, loadDiceSets, rollSet, removeSet, displayRollHistory, clearRollHistory) ...
        // These remain the same as in the previous version

        function addDiceSet() {
            const name = prompt('Enter set name:') || 'New Set';
            const formula = prompt('Enter formula (e.g., 2d6+3):') || '1d20';
            
            const sets = JSON.parse(localStorage.getItem('diceSets') || '[]');
            sets.push({name, formula});
            localStorage.setItem('diceSets', JSON.stringify(sets));
            loadDiceSets();
        }

        function loadDiceSets() {
            const sets = JSON.parse(localStorage.getItem('diceSets') || '[]');
            const container = document.getElementById('savedDiceSets');
            
            if (sets.length === 0) {
                container.innerHTML = '<p contenteditable="true">No saved sets yet. Add one!</p>';
                return;
            }
            
            container.innerHTML = sets.map((set, index) => `
                <div class="dice-set" data-index="${index}">
                    <span class="set-name" contenteditable="true">${set.name}</span>
                    <span class="set-formula" contenteditable="true">${set.formula}</span>
                    <button onclick="rollSet(this)">Roll</button>
                    <button onclick="removeSet(this)">X</button>
                </div>
            `).join('');
        }

        function rollSet(button) {
            const setDiv = button.parentElement;
            const formula = setDiv.querySelector('.set-formula').textContent;
            
            const match = formula.match(/(\d*)d(\d+)([+-]\d+)?/i);
            if (!match) return;
            
            const count = parseInt(match[1]) || 1;
            const sides = parseInt(match[2]);
            const mod = parseInt(match[3]) || 0;
            
            let total = 0;
            let rolls = [];
            
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            const finalResult = total + mod;
            const resultText = `${formula} = [${rolls.join(' + ')}]${mod >= 0 ? '+' : ''}${mod} = ${finalResult}`;
            
            document.getElementById('resultValue').textContent = finalResult;
            displayDiceVisual(rolls, sides, 'normal');
            document.getElementById('rollDetails').innerHTML = `<div contenteditable="true">${resultText}</div>`;
            
            const timestamp = new Date().toLocaleTimeString();
            rollHistory.unshift({formula, result: finalResult, details: resultText, time: timestamp, rolls: rolls});
            rollHistory = rollHistory.slice(0, 50);
            localStorage.setItem('rollHistory', JSON.stringify(rollHistory));
            displayRollHistory();
        }

        function removeSet(button) {
            const setDiv = button.parentElement;
            const index = parseInt(setDiv.dataset.index);
            
            const sets = JSON.parse(localStorage.getItem('diceSets') || '[]');
            sets.splice(index, 1);
            localStorage.setItem('diceSets', JSON.stringify(sets));
            loadDiceSets();
        }

        function displayRollHistory() {
            const container = document.getElementById('rollHistory');
            if (rollHistory.length === 0) {
                container.innerHTML = '<p contenteditable="true">No rolls yet...</p>';
                return;
            }
            container.innerHTML = rollHistory.slice(0, 10).map(entry => `
                <div class="history-item" contenteditable="true">
                    <strong>${entry.formula}</strong> = ${entry.result} 
                    ${entry.rolls ? `<small>(${entry.rolls.join(', ')})</small>` : ''}
                    <small>(${entry.time})</small>
                </div>
            `).join('');
        }

        function clearRollHistory() {
            if (confirm('Clear all roll history?')) {
                rollHistory = [];
                localStorage.removeItem('rollHistory');
                displayRollHistory();
            }
        }

        document.getElementById('savedDiceSets').addEventListener('blur', function(e) {
            if (e.target.classList.contains('set-name') || e.target.classList.contains('set-formula')) {
                const sets = Array.from(document.querySelectorAll('.dice-set')).map(setDiv => ({
                    name: setDiv.querySelector('.set-name').textContent,
                    formula: setDiv.querySelector('.set-formula').textContent
                }));
                localStorage.setItem('diceSets', JSON.stringify(sets));
            }
        }, true);
    </script>

    <style>
        .quick-dice-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .dice-btn {
            padding: 0.75rem 1rem;
            border: 2px solid var(--accent);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .dice-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .dice-btn.fate {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: white;
        }

        .dice-visual-container {
            min-height: 80px;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .roll-details {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-family: monospace;
        }

        .roll-style-selector {
            margin: 1rem 0;
        }

        .roll-style-selector select {
            width: auto;
            margin-left: 0.5rem;
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(0.8); opacity: 0; }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .quick-dice-buttons {
                justify-content: center;
            }
            
            .dice-btn {
                flex: 1;
                min-width: 60px;
            }
        }
    </style>
</body>
</html>
